---
output: html_document
editor_options: 
  chunk_output_type: console
---

# Phylogenetic Analyses, No Clonal Samples
```{r, include=FALSE}
knitr::opts_chunk$set(echo = T, warning = F, message = F, eval = T, results = 'hide',
                      fig.align = 'center', fig.width = 8, fig.height = 8)
```


```{r}
library(tidyverse)
library(Biostrings)
library(ape)
library(phangorn)
library(ggtree)
set.seed(48)
```

```{r}
#---------------------------------------------------- 
# Read In
#---------------------------------------------------- 
mtdna <- Biostrings::readDNAStringSet(filepath = "~/Documents/GitHub/VivID_Seq/PopGenome_Analysis/data/noclonefasta/unique_mtdna.fa")

# going to drop the ancestral haplo here because I will do an unrooted tree
# since we are not estimating the molecular clock
mtdna <- mtdna[!names(mtdna) %in% "Anc"]


mtdt <- readRDS("~/Documents/GitHub/VivID_Seq/PopGenome_Analysis/data/derived_data/mtdt.RDS") %>% 
  dplyr::filter(hapuid == "Y")

```



### Distance Metrics
```{r}
mtdna.unique.ape <- ape::as.DNAbin(mtdna)

mtdna.dist.JC <- ape::dist.dna(mtdna.unique.ape, model="JC69")
mtdna.dist.n <- ape::dist.dna(mtdna.unique.ape, model="N")
```


```{r, results='asis', fig.width=11, fig.height=8}

# plot
JC69plot <- broom::tidy(mtdna.dist.JC) %>% 
  magrittr::set_colnames(c("smpl1", "smpl2", "dist")) %>% 
  ggplot(data=.) +
  geom_tile(aes(x=smpl1, y=smpl2, fill=dist)) +
  ggtitle("Genetic Distance under Jukes-Cantor's 1969 Model") +
  scale_fill_gradient(low = "#fee0d2", high = "#de2d26") +
  theme_minimal() +
  theme(axis.text.y = element_text(size = 5),
        axis.text.x = element_text(angle=90, size = 5),
        axis.title = element_blank(),
        plot.title = element_text(family = "Arial", face = "bold", size = 14, hjust=0.5))
  
pairwiseplot <- broom::tidy(mtdna.dist.n) %>% 
  magrittr::set_colnames(c("smpl1", "smpl2", "dist")) %>% 
  ggplot(data=.) +
  geom_tile(aes(x=smpl1, y=smpl2, fill=dist)) +
  ggtitle("Genetic Pairwise Distance \n (Hammings)") +
  scale_fill_gradient(low = "#fee0d2", high = "#de2d26") +
  theme_minimal() +
  theme(axis.text.y = element_text(size = 5),
        axis.text.x = element_text(angle=90, size = 5),
        axis.title = element_blank(),
        plot.title = element_text(family = "Arial", face = "bold", size = 14, hjust=0.5))
  
gridExtra::grid.arrange(JC69plot, pairwiseplot, ncol=2)


```


### Analyze Dist Model Fit

Here we will check the tree versus distance correlation matrix to determine if the Jukes-Cantor approach is appropriate as was done in [Rodrigues et al. 2018](https://www.ncbi.nlm.nih.gov/pmc/articles/PMC5792595/). Follow Thibaut's [tutorial](http://adegenet.r-forge.r-project.org/files/MRC-session2-tuto.1.3.pdf) for this (Thanks, Thibaut)!
Generate a NJ tree (purpose isn't to be informative), but need topology for distance metric fit correlation check.


```{r, results='asis'}

par(mfrow=c(1,2))

tree <- ape::njs(mtdna.dist.JC)

x <- as.vector(mtdna.dist.JC) # collapse this distance matrix
y <- as.vector(as.dist(cophenetic(tree))) # collapse tree distance matrix, cophentic metric, is a measure of how faithfully a dendrogram preserves the pairwise distances between the original unmodeled data points
plot(x, y, xlab = "original distance", ylab = "tree dist",
     main = "Is JC69 appropriate?", pch = 20, col = scales::alpha("black",  0.1), cex = 3)
abline(lm(y ~ x), col = "red")


x <- as.vector(mtdna.dist.n) # collapse this distance matrix
plot(x, y, xlab = "original distance", ylab = "tree dist",
     main = "Is Hammings appropriate?", pch = 20, col = scales::alpha("black",  0.1), cex = 3)
abline(lm(y ~ x), col = "red")


graphics.off()

```
Looks like Hammings or JC are appropriate. Will use JC69 based on empirical evidence/evolutionary theory.


## MLE for Final Tree
This follows the classic [Felsenstein's 1981 approach](https://link.springer.com/article/10.1007/BF01734359) as outlined by the [phangorn tutorial](https://cran.r-project.org/web/packages/phangorn/vignettes/Trees.pdf).
 

```{r}
# phangorn objects
mtdna.unique.phangorn <- phangorn::as.phyDat(mtdna.unique.ape)
tree.init <- ape::nj(mtdna.dist.JC)

```
 
### Jukes-Cantor Model Fit
```{r}
JCfit.init <- phangorn::pml(tree.init, mtdna.unique.phangorn)
# optimized fit
fitJC <- readRDS("~/Documents/GitHub/VivID_Seq/PopGenome_Analysis/clonal_smpl_tree_results/JCmodelfit.RDS")

```




### GTR Fit
Note, I fit the process above JC69 model but am now going to maximize the Markovian DNA base-substituion model using a gamma distribution. This is the $GTR + \Gamma(4)$ (Global Time Reverse) model presented by [TavarÃ© 1986](http://www.damtp.cam.ac.uk/user/st321/CV_&_Publications_files/STpapers-pdf/T86.pdf). This model is widely considered the most flexible for a finite-sites, neutral sequence (i.e. the mtDNA).

```{r, results='asis'}
fitGTR.init <- phangorn::pml(tree.init, mtdna.unique.phangorn, k=4)
# optimized fit
fitGTR <- readRDS("~/Documents/GitHub/VivID_Seq/PopGenome_Analysis/clonal_smpl_tree_results/GTRfit.RDS")
```

### Model Comparison
```{r, results='asis'}

out <- cbind.data.frame(model = c("JC69", "GTR"),
                        as.data.frame(anova(fitJC, fitGTR)),
                        AIC = c(AIC(fitJC), AIC(fitGTR)))

knitr::kable(out)

```

GTR model is a much better fit than JC (no surprise).


## Bootstrapping MLE-GTR Tree
Going to bootstrapped our MLE tree under the GTR model for 1e4 iterations. 
```{r}
bs <- readRDS("~/Documents/GitHub/VivID_Seq/PopGenome_Analysis/clonal_smpl_tree_results/GTR_bootstraptrees.RDS")
clad <- prop.clades(fitGTR$tree, bs, rooted = F)
bootval <- data.frame(node = sort(unique(fitGTR$tree$edge[,1])),
                      bs = clad)

```



## Pretty Tree
```{r}
tree <- fitGTR$tree
tidytree <-  treeio::as.treedata(tree)

#----------------------------------------------------
# Need to do some liftover work
#----------------------------------------------------
treemtdt <- mtdt %>% 
  dplyr::rename(label = smpls) %>% 
  dplyr::select(c("label", "country", "vividregion", "k", "hapuid")) %>% 
  dplyr::mutate(country = ifelse(vividregion == "NHA", "NHA", country)) %>% 
  dplyr::filter(hapuid == "Y")

tidytree <- full_join(tidytree, treemtdt, by = 'label')
tidytree@extraInfo$country[is.na(tidytree@extraInfo$vividregion)] <- "zinternal"
tidytree@extraInfo$vividregion[is.na(tidytree@extraInfo$vividregion)] <- "zinternal"

# add bootstrap
bootval <- data.frame(node = sort(unique(tree$edge[,1])),
                    bs = clad)

tidytree <- full_join(tidytree, bootval, by ="node")


bstree_plotObj <- ggtree(tidytree, 
                         branch.length="none",
                         layout="circular", 
                         aes(color = country)) + 
  geom_tiplab(aes(label = label), fontface = "bold", size = 1.1, color = "#000000") +
  geom_tippoint(aes(shape=country)) +
  geom_point2(aes(subset=!isTip, 
                  fill=cut(bs, c(0, 900, 950, 1000))), 
              shape=21, size=1) +
  scale_fill_manual(values=c("#d9d9d9", "#737373", "#000000"), guide='legend', 
                    name='Bootstrap Percentage(BP)', 
                    breaks=c('(950,1e+03]', '(900,950]', '(0,900]'), 
                    labels=expression(BP>=95, 90 <= BP * " < 95", BP < 90)) + 
  scale_color_manual("Country",
                    values = c("#33FDFF", # BR
                               "#e41a1c", # CD
                               "#33F600", # CN
                               "#15FFF7", # CO
                               "#A515FF", # ET
                               "#2FFF15", # ID
                               "#A515FF", # IN
                               "#86FF52", # KH
                               "#3ECE00", # LA
                               "#921CFF", # LK
                               "#FF6D1C", # MG
                               "#A2FE10", # MM
                               "#45FFEB", # MX
                               "#00F52B", # MY
                               "#F500E4", # NHA
                               "#00A0F5", # PE
                               "#00F571", # PG
                               "#9FFC4C", # TH 
                               "#72F201", # VN
                               "#000000" # internal
                    )) + 
  theme_tree(legend.position=c(0.02, 0.5)) 

```

```{r, results='asis', fig.width=11, fig.height=8, fig.align='center'}
plot(bstree_plotObj)

jpeg("~/Documents/GitHub/VivID_Seq/PopGenome_Analysis/figures/mtdna_phylogenetic_tree.jpg", height = 8, width = 11, units = "in", res = 500)
plot(bstree_plotObj)
graphics.off()

```

