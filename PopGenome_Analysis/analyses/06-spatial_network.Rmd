---
output: html_document
editor_options: 
  chunk_output_type: console
---

# Section 4: Spatial Haplotype Sharing
```{r, include=FALSE}
knitr::opts_chunk$set(echo = T, warning = F, message = F, eval = T, results = 'hide',
                      fig.align = 'center', fig.width = 8, fig.height = 8)
```


```{r}
library(tidyverse)
library(sf)
library(rgeos)
library(rworldmap)
library(tidygraph)
library(ape)

```


```{r}
#---------------------------------------------------- 
# Read In Clonal Correction Files
#---------------------------------------------------- 
hapcounts <- readRDS("~/Documents/GitHub/VivID_Seq/PopGenome_Analysis/data/derived_data/mtdna_uniquehap_list.RDS") %>% 
  purrr::map(., "unihapcounts") %>% 
  dplyr::bind_rows() %>% 
  dplyr::filter(smpls != "Anc")

mtdna <- Biostrings::readDNAStringSet(filepath = "~/Documents/GitHub/VivID_Seq/PopGenome_Analysis/data/noclonefasta/unique_mtdna.fa")
mtdna <- mtdna[ names(mtdna) != "Anc" ]

```


```{r}
#---------------------------------------------------- 
# Read In MetaData
#---------------------------------------------------- 
smpls <- readRDS("~/Documents/GitHub/VivID_Seq/PopGenome_Analysis/data/derived_data/mtdt.RDS")

smpls <- smpls %>% 
  dplyr::filter(smpls %in% names(mtdna))


#---------------------------------------------------- 
# Read In Haplotype Counts
#---------------------------------------------------- 
smpls <- dplyr::left_join(smpls, hapcounts, by = "smpls")


```


```{r}
#---------------------------------------------------- 
# Add Jitter to Smpls
#---------------------------------------------------- 
smpls.nodrc <- smpls %>% 
  dplyr::filter(country != "CD")

smpls.nodrc <- sf::st_as_sf(smpls.nodrc, coords = c("x", "y"), crs = 4326) %>% 
  sf::st_jitter(., amount = 1.5)

# no jitter to drc, only one sample
smpls.drc <- smpls %>% 
  dplyr::filter(country == "CD") %>% 
  sf::st_as_sf(., coords = c("x", "y"), crs = 4326)


# come together
smpls <- rbind.data.frame(smpls.nodrc, smpls.drc)


```

```{r}
#---------------------------------------------------- 
# Make This a Spatial Network By Converting this to
# a SpatialLines Object
#---------------------------------------------------- 

# get combinations that will serve as endpoints for our lines
cntrylines <- smpls %>% 
  dplyr::select(c("smpls", "geometry"))
join1 <- cntrylines %>% 
  dplyr::rename(x = smpls)
join2 <- cntrylines %>% 
  dplyr::rename(y = smpls)


cntrylines.combos <- cntrylines$smpls
cntrylines.combos <- tibble::as_tibble( t( combn(cntrylines.combos, 2) ) )
cntrylines.combos <- cntrylines.combos %>% 
  magrittr::set_colnames(c("x", "y")) %>% 
  dplyr::filter( x != y)

cntrylines.combos <- dplyr::left_join(cntrylines.combos, join1, by = "x") %>% 
  dplyr::left_join(., join2, by = "y")

# make lines
cntrylines.combos$geometry <- purrr::map2(cntrylines.combos$geometry.x, cntrylines.combos$geometry.y, 
                                          function(x, y){
                                            ret <- sf::st_cast(x = c(x,y), to = "LINESTRING")
                                          }) 
cntrylines.combos <- cntrylines.combos %>% 
  dplyr::select(-c("geometry.x", "geometry.y"))

cntrylines.sf <- sf::st_as_sf(cntrylines.combos, crs = 4326)

```

```{r}
#---------------------------------------------------- 
# Tidy Networks Up and Get Nodes
# Thanks again https://www.r-spatial.org/r/2019/09/26/spatial-networks.html
#---------------------------------------------------- 
#.....................
# Get Edges
#.....................
edges <- cntrylines.sf %>%
  mutate(edgeID = c(1:n()))

#.....................
# Get Nodes
#.....................
nodes <- edges %>%
  sf::st_coordinates() %>%
  tibble::as_tibble() %>%
  dplyr::rename(edgeID = L1) %>%
  dplyr::group_by(edgeID) %>%
  dplyr::slice(c(1, n())) %>%
  dplyr::ungroup() %>%
  dplyr::mutate(start_end = rep(c('start', 'end'), times = n()/2)) %>%
  mutate(xy = paste(.$X, .$Y)) %>% 
  mutate(nodeID = group_indices(., factor(xy, levels = unique(xy)))) %>%
  select(-xy)

# note at this point, add sample level information to nodes
smpls.join <- smpls
smpls.join$X <- sf::st_coordinates(smpls)[,1]
smpls.join$Y <- sf::st_coordinates(smpls)[,2]
nodes <- dplyr::left_join(x = nodes, y = smpls.join, by = c("X", "Y"))

#...................................
# Find Node Endpoints for Edges
#..................................
source_nodes <- nodes %>%
  filter(start_end == 'start') %>%
  pull(nodeID)

target_nodes <- nodes %>%
  filter(start_end == 'end') %>%
  pull(nodeID)

edges = edges %>%
  mutate(from = source_nodes, to = target_nodes)

#.....................
# Remove Node Endpoints details
#.....................
nodes <- nodes %>%
  distinct(nodeID, .keep_all = TRUE) %>%
  select(-c(edgeID, start_end)) %>%
  st_as_sf(coords = c('X', 'Y')) %>%
  st_set_crs(st_crs(edges))


#.....................
# Make to TidyGraph Object
#.....................
mtdnanetwork <- tidygraph::tbl_graph(nodes = nodes, 
                                     edges = as_tibble(edges), 
                                     directed = FALSE)


```

```{r}
#---------------------------------------------------- 
# Get World Background
#---------------------------------------------------- 
bb <- sf::st_bbox(
  sf::st_sf(geom = sf::st_sfc(
    sf::st_point(c(-108, -35)), # left lower
    sf::st_point(c(150, -35)), # right lower
    sf::st_point(c(-108, 50)), # left upper
    sf::st_point(c(150, 50)), # right upper
    crs = sf::st_crs("+proj=longlat +datum=WGS84 +no_defs"))
  ))


world <- rnaturalearth::ne_countries(scale = "medium", returnclass = "sf") %>% 
  sf::st_crop(., y=bb) 

```

```{r}
#---------------------------------------------------- 
# Get Hammings String Dist Between Haplotypes
#---------------------------------------------------- 
# use ape so we ignore as missing data 
mtdna.ape <- ape::as.DNAbin(mtdna)

mtdna.dist.JC <- ape::dist.dna(mtdna.ape, model="JC69")
mtdna.dist.n <- ape::dist.dna(mtdna.ape, model="N")


mtdnadistlong <- broom::tidy(mtdna.dist.n) %>% 
  magrittr::set_colnames(c("x", "y", "hammings"))

# get complement comparisons for easier join
revmtdnadistlong <- mtdnadistlong %>% 
  dplyr::select(c("y", "x", "hammings")) %>% 
  magrittr::set_colnames(c("x", "y", "hammings"))

mtdnadistlong <- rbind.data.frame(mtdnadistlong, revmtdnadistlong) 

# add in some details for sanity
join1 <- smpls %>% 
  dplyr::rename(x = smpls) %>% 
  dplyr::select(c("x", "country"))
sf::st_geometry(join1) <- NULL
join2 <- smpls %>% 
  dplyr::rename(y = smpls) %>% 
  dplyr::select(c("y", "country"))
sf::st_geometry(join2) <- NULL
mtdnadistlong <- mtdnadistlong %>% 
  dplyr::left_join(., join1, by = "x") %>% 
  dplyr::left_join(., join2, by = "y")

```

```{r}
#---------------------------------------------------- 
# Bind Distance and Space
#---------------------------------------------------- 
drcsmpls <- smpls$smpls[smpls$country == "CD"]
nhasmpls <- smpls$smpls[smpls$vividregion == "NHA"]

mtdnanetwork <- mtdnanetwork %>% 
  tidygraph::activate(edges) %>% 
  dplyr::left_join(., mtdnadistlong, by = c("x", "y")) 

lines <- mtdnanetwork %>% 
  tidygraph::activate(edges) %>% as_tibble() %>% st_as_sf() %>% 
  dplyr::filter(x %in% drcsmpls | y %in% drcsmpls) %>% # only look at DRC
  dplyr::filter(hammings ==1) # have to be within 1 bp 

points <- mtdnanetwork %>% 
  activate(nodes) %>% as_tibble() %>% st_as_sf() %>% 
  dplyr::mutate(country = ifelse(vividregion == "NHA", "NHA", country),
                x = sf::st_coordinates(.)[,1],
                y = sf::st_coordinates(.)[,2])
# seperate out drc and other for plotting
points.nodrc <- points %>% 
  dplyr::filter(country != "CD")
points.drc <- points %>% 
  dplyr::filter(country == "CD")

# cool to warm colors
# cool <- rainbow(50, start=rgb2hsv(col2rgb('cyan'))[1], end=rgb2hsv(col2rgb('blue'))[1])
# warm <- rainbow(50, start=rgb2hsv(col2rgb('red'))[1], end=rgb2hsv(col2rgb('yellow'))[1])
# cols <- c(rev(cool), rev(warm))
# pal <- colorRampPalette(cols)(101)

mtDNAglobal <- ggplot() +
  geom_sf(data = world, color = "#ffffff", fill = "#000000", size = 0.05) +
  geom_sf(data = lines, color = "#e31a1c", size = 0.8, alpha = 0.5, show.legend = F) +
  geom_point(data = points.nodrc, aes(x = x, y = y, 
                                      size = hapuid_count, fill = factor(country)), shape = 21, stroke = 0, show.legend = F, alpha = 0.8) +
  geom_point(data = points.drc, aes(x = x, y = y), size = 3, shape = 17, color = "#f0f0f0",  show.legend = F) +
#  scale_color_gradientn("Hamming's \n Distance", colours = pal) + 
  scale_size_continuous(range = c(1.4,4)) +
  scale_fill_manual("Country",
                    values = c("#33FDFF", # BR
                               "#33F600", # CN
                               "#15FFF7", # CO
                               "#A515FF", # ET
                               "#2FFF15", # ID
                               "#A515FF", # IN
                               "#86FF52", # KH
                               "#3ECE00", # LA
                               "#921CFF", # LK
                               "#FF6D1C", # MG
                               "#A2FE10", # MM
                               "#45FFEB", # MX
                               "#00F52B", # MY
                               "#F500E4", # NHA
                               "#00A0F5", # PE
                               "#00F571", # PG
                               "#9FFC4C", # TH 
                               "#72F201" # VN
                    )) +
  theme(plot.title = element_blank(),
        axis.title = element_blank(),
        axis.text = element_blank(),
        legend.position = "bottom",
        legend.title = element_blank(),
        legend.text = element_text(family = "Helvetica", hjust = 0.5, vjust = 0.5, size = 10),
        plot.background = element_rect(fill = "transparent"),
        panel.grid = element_blank(),
        panel.border = element_blank(),
        panel.background = element_rect(fill = "#deebf7")) +
  coord_sf(xlim = c(bb['xmin'], bb['xmax']), 
           ylim = c(bb['ymin'], bb['ymax']), 
           datum = NA) +
  ggspatial::annotation_north_arrow(location = "bl", which_north = "true", size = 0.8)

```


```{r, results='asis', fig.align='center', fig.width = 11, fig.height = 8}
plot(mtDNAglobal)

jpeg("~/Documents/GitHub/VivID_Seq/PopGenome_Analysis/figures/mtdna_spatial_network_wide.jpg", height = 8, width = 11, units = "in", res = 500)
plot(mtDNAglobal)
graphics.off()

jpeg("~/Documents/GitHub/VivID_Seq/PopGenome_Analysis/figures/mtdna_spatial_network_long.jpg", height = 11, width = 8, units = "in", res = 500)
plot(mtDNAglobal)
graphics.off()


```

