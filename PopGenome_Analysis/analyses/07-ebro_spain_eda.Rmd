---
output: html_document
editor_options: 
  chunk_output_type: console
---

# Ebro Spain, 1944 Isolate
```{r}
library(tidyverse)
library(Biostrings)
library(vcfR)
source("~/Documents/GitHub/VivID_Seq/PopGenome_Analysis/R/vcf_utils.R")
```

```{r}
#........................................................
# Read in fastas
#........................................................
pvp01 <- Biostrings::readDNAStringSet("~/Documents/MountPoints/mountIDEEL/resources/genomes/Pvivax/genomes/PvP01.fasta")
                            
pvp01 <- pvp01[ names(pvp01) == "PvP01_MIT_v1" ]

```
```{r}
#.................................
# Read in data
#.................................
ebro <- vcfR::read.vcfR("~/Documents/MountPoints/mountedScratchLL/Projects/VivID_Seq/Ebro1944/Ebro1944.vcf")
pos <- readRDS("~/Documents/GitHub/VivID_Seq/PopGenome_Analysis/data/derived_data/final_positions.rds")

#.................................
# Read in Metadata
#.................................
mtdt <- readRDS("~/Documents/GitHub/VivID_Seq/PopGenome_Analysis/data/derived_data/mtdt.RDS")


ebromtdt <- data.frame(iid = "Ebro-1944", smpls = "Ebro-1944", country = "ES", vividregion = "Ebro", passed = "Y", hapuid = NA, x = NA, y = NA, k = NA)

mtdt <- rbind.data.frame(mtdt, ebromtdt)

```

```{r}
#........................................................
# SNPs only
#........................................................
ebro.snp <- vcfR::extract.indels(ebro, return.indels = F)
ebro.snp

#........................................................
# Get POS
#........................................................
ebroliftover <- data.frame(POS = vcfR::getPOS(ebro.snp),
                           GT = vcfR::extract.gt(ebro.snp),
                           REF = vcfR::getREF(ebro.snp),
                           ALT = vcfR::getALT(ebro.snp))
ebroliftover <- ebroliftover %>% 
  dplyr::filter(POS %in% pos)

#........................................................
# Do liftover
#........................................................
ebro <- pvp01
for(i in 1:length(ebroliftover$POS)){
  ebro[[1]][ebroliftover$POS[i]] <- as.character( ebroliftover$ALT[i] ) # all 1/1
}
```


```{r}

mtdna <- Biostrings::readDNAStringSet(filepath = "~/Documents/GitHub/VivID_Seq/PopGenome_Analysis/data/fasta/mtdna_anc.fa")

# going to drop the ancestral haplo here because I will do an unrooted tree
# since we are not estimating the molecular clock
mtdna <- mtdna[!names(mtdna) %in% "Pcynomolgi"]

# going to add ebro
mtdna[length(mtdna) + 1] <- ebro
names(mtdna)[length(mtdna)] <- "Ebro-1944"

seqmat <-  tibble::as_tibble( t(as.matrix(mtdna) ) )
seqmat <- cbind.data.frame(POS = 1:nrow(seqmat), seqmat)

segsites <- apply(seqmat[,2:ncol(seqmat)], 1, function(x){ return( length(unique(x)) > 1 ) })


seqmat.long <- seqmat %>% 
  dplyr::filter(segsites) %>% 
  tidyr::gather(., key = "smpls", value = "GT", 2:ncol(.)) %>% 
  dplyr::mutate(GT = factor(GT)) %>% 
  dplyr::left_join(., mtdt, by = "smpls") %>% 
  dplyr::filter(passed == "Y") %>% 
  dplyr::mutate(POS = factor(POS, levels = c(1:5989), ordered = T)) 

gtplot <- seqmat.long %>% 
  ggplot() + 
  geom_tile(aes(x = smpls, y = POS, fill = GT)) + 
  scale_fill_manual("Alleles", values = c("#4daf4a", "#377eb8", "#ffff33", "#e41a1c")) +
  facet_wrap(~k + country, scales = "free_x", nrow = 1, strip.position = "top") +
  theme(axis.text.x = element_blank(),
        axis.title.x = element_blank())

jpeg("~/Documents/GitHub/VivID_Seq/PopGenome_Analysis/figures/ebro_compare.jpg", height = 8, width = 14, units = "in", res = 500)
plot(gtplot)
graphics.off()

```

## Spain 1944 Visualization
Isolate from near the Ebro River in Spain dating to 1944 (microscopy slide collection from the Victorian Era).
```{r, results='asis', fig.width=11, fig.height=8, fig.align='center'}
plot(gtplot)
```







